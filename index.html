<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bottled - Message in a Bottle</title>
    <style>
        /* General Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /*  */
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); /*  */
            min-height: 100vh; /*  */
            color: #333; /*  */
            overflow-x: hidden; /*  */
        }

        .ocean-bg {
            position: fixed; /*  */
            top: 0; /*  */
            left: 0; /*  */
            width: 100%; /*  */
            height: 100%; /*  */
            background:
                radial-gradient(circle at 20% 80%, rgba(120, 219, 226, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); /*  */
            z-index: -1; /*  */
        }

        .waves {
            position: fixed; /*  */
            bottom: 0; /*  */
            left: 0; /*  */
            width: 100%; /*  */
            height: 100px; /*  */
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 120'%3E%3Cpath d='M0,60 C200,100 400,20 600,60 C800,100 1000,20 1200,60 L1200,120 L0,120 Z' fill='rgba(255,255,255,0.1)'/%3E%3C/svg%3E") repeat-x; /*  */
            animation: wave 15s ease-in-out infinite; /*  */
            z-index: -1; /*  */
        }

        @keyframes wave {
            0%, 100% { transform: translateX(0px); } /*  */
            50% { transform: translateX(-50px); } /*  */
        }

        .container {
            max-width: 1200px; /*  */
            margin: 0 auto; /*  */
            padding: 20px; /*  */
            min-height: 100vh; /*  */
            display: flex; /*  */
            flex-direction: column; /*  */
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.15); /*  */
            backdrop-filter: blur(15px); /*  */
            border-radius: 20px; /*  */
            padding: 20px; /*  */
            margin-bottom: 20px; /*  */
            display: flex; /*  */
            justify-content: space-between; /*  */
            align-items: center; /*  */
            color: white; /*  */
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); /*  */
        }

        .logo {
            font-size: 28px; /*  */
            font-weight: bold; /*  */
            display: flex; /*  */
            align-items: center; /*  */
            gap: 10px; /*  */
        }

        .bottle-icon {
            font-size: 32px; /*  */
            animation: float 3s ease-in-out infinite; /*  */
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); } /*  */
            50% { transform: translateY(-10px); } /*  */
        }

        /* Main Content Layout */
        .main-content {
            display: flex; /*  */
            flex: 1; /*  */
            gap: 20px; /*  */
            height: calc(100vh - 140px); /*  */
        }

        /* Sidebar & Connections */
        .sidebar {
            background: rgba(255, 255, 255, 0.15); /*  */
            backdrop-filter: blur(15px); /*  */
            border-radius: 20px; /*  */
            padding: 25px; /*  */
            width: 350px; /*  */
            display: flex; /*  */
            flex-direction: column; /*  */
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); /*  */
        }

        .bottle-section {
            text-align: center; /*  */
            margin-bottom: 30px; /*  */
            padding: 20px; /*  */
            background: rgba(255, 255, 255, 0.1); /*  */
            border-radius: 15px; /*  */
        }

        .bottle {
            font-size: 80px; /*  */
            cursor: pointer; /*  */
            transition: all 0.3s; /*  */
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.2)); /*  */
        }
        .bottle:hover {
            transform: scale(1.1) rotate(5deg); /*  */
            filter: drop-shadow(0 8px 25px rgba(0,0,0,0.3)); /*  */
        }
        .bottle.opening {
            animation: shake 0.5s ease-in-out, glow 0.5s ease-in-out; /*  */
        }

        .user-list {
            flex: 1; /*  */
            overflow-y: auto; /*  */
        }

        .user-item {
            padding: 15px; /*  */
            border-radius: 12px; /*  */
            margin-bottom: 10px; /*  */
            cursor: pointer; /*  */
            transition: all 0.3s; /*  */
            display: flex; /*  */
            align-items: center; /*  */
            gap: 12px; /*  */
            background: rgba(255, 255, 255, 0.1); /*  */
            color: white; /*  */
            position: relative; /*  */
        }
        .user-item:hover {
            background: rgba(255, 255, 255, 0.2); /*  */
            transform: translateX(5px); /*  */
        }
        .user-item.active {
            background: rgba(120, 219, 226, 0.3); /*  */
        }

        .unread-badge {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background-color: #78dbe2;
            color: #1e3c72;
            font-size: 12px;
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 12px;
            transition: all 0.3s;
        }

        /* Chat Area */
        .chat-area {
            flex: 1; /*  */
            background: rgba(255, 255, 255, 0.95); /*  */
            border-radius: 20px; /*  */
            display: flex; /*  */
            flex-direction: column; /*  */
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); /*  */
        }
        
        .chat-header {
            padding: 25px; /*  */
            border-bottom: 1px solid rgba(0,0,0,0.1); /*  */
            font-weight: 600; /*  */
            color: #2a5298; /*  */
            font-size: 18px; /*  */
        }

        .messages-container {
            flex: 1; /*  */
            padding: 20px; /*  */
            overflow-y: auto; /*  */
            display: flex; /*  */
            flex-direction: column; /*  */
            gap: 2px; /* Reduced gap for message grouping */
            scroll-behavior: smooth; /*  */
        }

        /* NEW: Empty state for chat area */
        .empty-chat-area {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            text-align: center;
            color: #666;
            padding: 20px;
        }
        .empty-chat-icon {
            font-size: 80px;
            margin-bottom: 20px;
            filter: drop-shadow(0 5px 10px rgba(0,0,0,0.1));
            animation: float 4s ease-in-out infinite;
        }


        .message {
            max-width: 75%; /*  */
            padding: 12px 18px;
            border-radius: 20px; /*  */
            position: relative; /*  */
            word-wrap: break-word; /*  */
            margin-top: 8px;
        }
        .message.sent {
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%); /*  */
            color: white; /*  */
            align-self: flex-end; /*  */
            border-bottom-right-radius: 6px; /*  */
        }
        .message.received {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); /*  */
            color: #333; /*  */
            align-self: flex-start; /*  */
            border-bottom-left-radius: 6px; /*  */
        }
        
        /* NEW: Grouped messages styling */
        .message.grouped {
            margin-top: 2px;
        }
        .message.sent.grouped {
            border-top-right-radius: 6px;
            border-bottom-right-radius: 6px;
        }
        .message.received.grouped {
            border-top-left-radius: 6px;
            border-bottom-left-radius: 6px;
        }

        /* NEW: Timestamp on hover */
        .message-info {
            display: none;
            font-size: 11px; /*  */
            opacity: 0.7; /*  */
        }
        .message:hover .message-info {
            display: block;
        }

        /* NEW: Message status indicator */
        .message-status {
            font-size: 14px;
            margin-left: 5px;
        }

        /* Compose Area & Typing Indicator */
        .compose-area {
            padding: 20px 25px;
            border-top: 1px solid rgba(0,0,0,0.1); /*  */
            display: flex; /*  */
            gap: 15px; /*  */
            align-items: flex-end; /*  */
            position: relative;
        }
        
        /* NEW: Moved typing indicator here */
        .typing-indicator {
            position: absolute;
            top: -32px;
            left: 25px;
            padding: 5px 15px;
            background: #f0f0f0;
            border-radius: 20px;
            border-bottom-left-radius: 6px;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: #555;
        }

        .typing-dots span {
            width: 7px;
            height: 7px;
            border-radius: 50%; /*  */
            background: #999; /*  */
            animation: typing 1.4s infinite ease-in-out; /*  */
        }
        .typing-dots span:nth-child(1) { animation-delay: -0.32s; } /*  */
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; } /*  */
        .typing-dots span:nth-child(3) { animation-delay: 0s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; } /*  */
            40% { transform: scale(1); opacity: 1; } /*  */
        }

        .compose-input {
            flex: 1; /*  */
            padding: 15px 20px; /*  */
            border: 2px solid #e1e5e9; /*  */
            border-radius: 25px; /*  */
            resize: none; /*  */
            font-family: inherit; /*  */
            font-size: 16px; /*  */
            min-height: 50px; /*  */
            max-height: 150px; /*  */
            transition: all 0.3s; /*  */
        }
        .compose-input:focus {
            outline: none; /*  */
            border-color: #2a5298; /*  */
            box-shadow: 0 0 0 3px rgba(42, 82, 152, 0.15); /*  */
        }
        
        .send-btn {
            width: 50px; /*  */
            height: 50px; /*  */
            border-radius: 50%; /*  */
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%); /*  */
            color: white; /*  */
            border: none; /*  */
            cursor: pointer; /*  */
            display: flex; /*  */
            align-items: center; /*  */
            justify-content: center; /*  */
            transition: all 0.3s; /*  */
            font-size: 18px; /*  */
        }
        .send-btn:hover {
            transform: scale(1.1); /*  */
            box-shadow: 0 5px 20px rgba(42, 82, 152, 0.4); /*  */
        }

        /* General & Utility Classes */
        .hidden { display: none !important; } /*  */

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column; /*  */
                height: auto; /*  */
            }
            .sidebar {
                width: 100%; /*  */
                order: 2; /*  */
                height: 350px;
            }
            .chat-area {
                order: 1; /*  */
                min-height: 500px; /*  */
            }
        }
    </style>
</head>
<body>
    <div class="ocean-bg"></div>
    <div class="waves"></div>
    
    <div class="container">
        <div class="header">
            <div class="logo">
                <span class="bottle-icon">üç∂</span>
                Bottled
            </div>
            <div class="user-info hidden" id="userInfo">
                <div class="user-avatar" id="userAvatar"></div>
                <span id="userName"></span>
                <button class="btn btn-danger" onclick="signOut()">Sign Out</button>
            </div>
        </div>

        <div class="auth-section" id="authSection">
             <h2>üåä Cast Your Message Into The Digital Ocean</h2>
            <div id="loginForm">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" placeholder="Enter your password">
                </div>
                <button class="btn btn-primary" onclick="signIn()">Sign In</button>
                <button class="btn btn-secondary" onclick="signUp()">Sign Up</button>
                <br><br>
                <button class="btn btn-secondary" onclick="signInWithGoogle()">üîó Sign in with Google</button>
            </div>
            <div id="authError" class="error hidden"></div>
        </div>

        <div class="main-content hidden" id="mainContent">
            <div class="sidebar">
                <div class="bottle-section">
                    <div class="bottle-container">
                        <div class="bottle" id="magicBottle" onclick="openBottle()" aria-label="Find a random connection">üç∂</div>
                    </div>
                    <div class="bottle-text">Find a Random Connection</div>
                    <div class="bottle-subtitle">Click the bottle to meet someone new</div>
                </div>

                <div class="connections-section">
                    <h3>Your Connections</h3>
                    <div class="user-list" id="userList">
                        </div>
                </div>
            </div>

            <div class="chat-area">
                <div class="chat-header" id="chatHeader">
                    </div>
                
                <div class="messages-container" id="messagesContainer">
                    <div class="empty-chat-area" id="emptyChatArea">
                        <div class="empty-chat-icon">üåä</div>
                        <h3>Welcome to the Ocean</h3>
                        <p>Open a bottle to find a new connection, or select an existing one to continue a conversation.</p>
                    </div>
                </div>

                <div class="compose-area" id="composeArea">
                    <textarea 
                        class="compose-input" 
                        id="messageInput" 
                        placeholder="Type your message..."
                        onkeypress="handleKeyPress(event)"
                        oninput="handleTyping()"
                    ></textarea>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()" aria-label="Send message">
                        ‚û§
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js'; /*  */
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut as firebaseSignOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js'; /*  */
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, where, getDocs, doc, setDoc, updateDoc, writeBatch, arrayUnion, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js'; /*  */
        import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js';

        // TODO: Replace with your Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyA1wrUreV-64WVaa1SmT02QKu-iKyY-Pvs",
          authDomain: "testapp-ced4f.firebaseapp.com",
          databaseURL: "https://testapp-ced4f.firebaseio.com",
          projectId: "testapp-ced4f",
          storageBucket: "testapp-ced4f.firebasestorage.app",
          messagingSenderId: "649071991572",
          appId: "1:649071991572:web:f7c5cf820021b07689c001",
          measurementId: "G-NV8M669RE2"
        }; /*  */
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig); /*  */
        const auth = getAuth(app); /*  */
        const db = getFirestore(app); /*  */
        const functions = getFunctions(app); // Initialize Cloud Functions

        // --- Global State ---
        window.currentUser = null; /*  */
        window.selectedUser = null; /*  */
        window.unsubscribeMessages = null; /*  */
        window.unsubscribeConnections = null; /*  */
        let typingTimer = null;

        // --- Authentication Functions (Largely Unchanged) ---
        window.signIn = async () => {
            const email = document.getElementById('email').value; /*  */
            const password = document.getElementById('password').value; /*  */
            try {
                await signInWithEmailAndPassword(auth, email, password); /*  */
            } catch (error) {
                showError(error.message); /*  */
            }
        };
        window.signUp = async () => {
            const email = document.getElementById('email').value; /*  */
            const password = document.getElementById('password').value; /*  */
            try {
                await createUserWithEmailAndPassword(auth, email, password); /*  */
            } catch (error) {
                showError(error.message); /*  */
            }
        };
        window.signInWithGoogle = async () => {
            try {
                await signInWithPopup(auth, new GoogleAuthProvider()); /*  */
            } catch (error) {
                showError(error.message); /*  */
            }
        };
        window.signOut = async () => {
            try {
                if (window.currentUser) {
                    await updateUserStatus(false); /*  */
                }
                await firebaseSignOut(auth); /*  */
            } catch (error) {
                console.error('Sign out error:', error); /*  */
            }
        };

        // --- Core Feature: Open Bottle (IMPROVED) ---
        // This function now calls a secure Cloud Function.
        window.openBottle = async () => {
            const bottle = document.getElementById('magicBottle'); /*  */
            bottle.classList.add('opening'); /*  */
            
            try {
                const findRandomConnection = httpsCallable(functions, 'findRandomConnection');
                const result = await findRandomConnection();
                
                if (result.data.success) {
                    const randomUser = result.data.user;
                    showNotification(`üç∂ You found ${randomUser.email}! Start chatting now!`); /*  */
                    // Real-time listener for connections will handle the UI update.
                }
            } catch (error) {
                console.error('Error opening bottle:', error); /*  */
                showNotification(error.message || "‚ùå Couldn't open the bottle. Try again!"); /*  */
            } finally {
                setTimeout(() => bottle.classList.remove('opening'), 500); /*  */
            }
        };

        // --- Messaging Functions (IMPROVED) ---
        window.sendMessage = async () => {
            const messageInput = document.getElementById('messageInput'); /*  */
            const messageText = messageInput.value.trim(); /*  */
            if (!messageText || !window.selectedUser) return; /*  */

            const chatId = getChatId(window.currentUser.uid, window.selectedUser.uid); /*  */
            
            // Clear input immediately for better UX
            messageInput.value = ''; /*  */
            messageInput.style.height = '50px'; /*  */
            handleTyping(true); // Stop typing indicator immediately

            try {
                await addDoc(collection(db, 'messages'), { /*  */
                    text: messageText, /*  */
                    senderId: window.currentUser.uid, /*  */
                    receiverId: window.selectedUser.uid, /*  */
                    chatId: chatId, /*  */
                    timestamp: serverTimestamp(), /*  */
                    read: false // NEW: Read receipt status
                });
            } catch (error) {
                console.error('Error sending message:', error); /*  */
                showNotification("‚ùå Failed to send message."); /*  */
            }
        };

        // --- Typing Indicator (IMPROVED) ---
        window.handleTyping = (forceStop = false) => {
            if (!window.selectedUser) return; /*  */
            const chatId = getChatId(window.currentUser.uid, window.selectedUser.uid); /*  */
            const typingRef = doc(db, 'typing', chatId); /*  */
            
            clearTimeout(typingTimer);
            
            if (forceStop) {
                setDoc(typingRef, { [window.currentUser.uid]: false }, { merge: true });
                return;
            }

            setDoc(typingRef, { [window.currentUser.uid]: true }, { merge: true });
            
            typingTimer = setTimeout(() => { /*  */
                setDoc(typingRef, { [window.currentUser.uid]: false }, { merge: true });
            }, 2000);
        };

        // --- UI & State Management (IMPROVED) ---
        function updateUIOnAuthStateChange(user) {
            const authSection = document.getElementById('authSection'); /*  */
            const mainContent = document.getElementById('mainContent'); /*  */
            const userInfo = document.getElementById('userInfo'); /*  */

            if (user) {
                window.currentUser = user; /*  */
                authSection.classList.add('hidden'); /*  */
                mainContent.classList.remove('hidden'); /*  */
                userInfo.classList.remove('hidden'); /*  */
                document.getElementById('userName').textContent = user.email; /*  */
                document.getElementById('userAvatar').textContent = user.email.charAt(0).toUpperCase();

                createUserDocument(user).then(() => { /*  */
                    updateUserStatus(true); /*  */
                    loadConnections(); /*  */
                });
                
            } else {
                window.currentUser = null; /*  */
                authSection.classList.remove('hidden'); /*  */
                mainContent.classList.add('hidden'); /*  */
                userInfo.classList.add('hidden'); /*  */
                
                // Cleanup
                if (window.unsubscribeMessages) window.unsubscribeMessages(); /*  */
                if (window.unsubscribeConnections) window.unsubscribeConnections(); /*  */
                document.getElementById('userList').innerHTML = '';
                showEmptyStateUI('no_chat_selected');
            }
        }
        
        window.selectUser = (user) => {
            if (window.selectedUser?.uid === user.uid) return; // Don't re-select same user

            window.selectedUser = user; /*  */
            
            // Update UI
            document.querySelectorAll('.user-item').forEach(item => item.classList.remove('active')); /*  */
            const selectedElement = document.querySelector(`[data-user-id="${user.uid}"]`);
            if (selectedElement) {
                selectedElement.classList.add('active'); /*  */
                // Remove unread badge
                const badge = selectedElement.querySelector('.unread-badge');
                if (badge) badge.remove();
            }
            
            document.getElementById('chatHeader').textContent = `üí¨ ${user.email}`; /*  */
            document.getElementById('emptyChatArea').classList.add('hidden');
            document.getElementById('composeArea').style.visibility = 'visible';
            
            loadMessages(); /*  */
            listenForTyping(); /*  */

            // Move focus to input
            document.getElementById('messageInput').focus();
        };

        // --- Data Loading (IMPROVED) ---
        function loadConnections() {
            const userRef = doc(db, 'users', window.currentUser.uid); /*  */
            
            window.unsubscribeConnections = onSnapshot(userRef, async (doc) => { /*  */
                const userData = doc.data(); /*  */
                const connectionIds = userData.connections || []; /*  */
                const userList = document.getElementById('userList'); /*  */
                
                if (connectionIds.length === 0) {
                    userList.innerHTML = '<div class="loading" style="color: white; text-align: center;">Open a bottle to begin...</div>'; /*  */
                    return;
                }
                
                userList.innerHTML = ''; // Clear list to rebuild
                
                for (const uid of connectionIds) {
                    const connDoc = await getDoc(doc(db, 'users', uid));
                    if (connDoc.exists()) {
                        addConnectionToUI(connDoc.data());
                    }
                }
            });
        }
        
        function loadMessages() {
            if (window.unsubscribeMessages) window.unsubscribeMessages(); /*  */

            const chatId = getChatId(window.currentUser.uid, window.selectedUser.uid); /*  */
            const messagesQuery = query(collection(db, 'messages'), where('chatId', '==', chatId), orderBy('timestamp', 'asc')); /*  */
            const messagesContainer = document.getElementById('messagesContainer'); /*  */
            messagesContainer.innerHTML = ''; // Clear previous chat /*  */

            window.unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => { /*  */
                snapshot.docChanges().forEach((change) => { /*  */
                    if (change.type === 'added') { /*  */
                        addMessageToUI(change.doc.id, change.doc.data());
                    }
                    if (change.type === 'modified') {
                        // For read receipts
                        const messageData = change.doc.data();
                        if (messageData.read) {
                            const statusEl = document.querySelector(`[data-message-id="${change.doc.id}"] .message-status`);
                            if (statusEl) {
                                statusEl.textContent = '‚úì‚úì';
                                statusEl.style.color = '#78dbe2'; // Read color
                            }
                        }
                    }
                });
                markMessagesAsRead(chatId);
            });
        }

        function listenForTyping() {
            const chatId = getChatId(window.currentUser.uid, window.selectedUser.uid); /*  */
            onSnapshot(doc(db, 'typing', chatId), (doc) => { /*  */
                const typingData = doc.data(); /*  */
                const otherUserTyping = typingData && typingData[window.selectedUser.uid]; /*  */
                showTypingIndicator(otherUserTyping);
            });
        }

        // --- UI Rendering Functions (IMPROVED) ---
        function addConnectionToUI(userData) {
            const userList = document.getElementById('userList'); /*  */
            const userElement = document.createElement('div');
            userElement.className = 'user-item'; /*  */
            userElement.setAttribute('data-user-id', userData.uid);
            
            userElement.innerHTML = `
                <div class="user-avatar">${userData.email.charAt(0).toUpperCase()}</div>
                <div>
                    <div>${userData.email}</div>
                    <div style="font-size: 12px; opacity: 0.7;">
                        ${userData.isOnline ? 'üü¢ Online' : '‚ö´ Offline'}
                    </div>
                </div>
                `; /*  */
            userElement.onclick = () => selectUser(userData); /*  */
            userList.appendChild(userElement); /*  */
        }

        function addMessageToUI(docId, message) {
            const messagesContainer = document.getElementById('messagesContainer'); /*  */
            const lastMessage = messagesContainer.lastElementChild;
            const isGrouped = lastMessage && lastMessage.dataset.senderId === message.senderId;

            const messageElement = document.createElement('div');
            messageElement.className = `message ${message.senderId === window.currentUser.uid ? 'sent' : 'received'}`; /*  */
            if (isGrouped) {
                messageElement.classList.add('grouped');
            }
            messageElement.dataset.senderId = message.senderId;
            messageElement.dataset.messageId = docId;

            let statusIcon = '';
            if (message.senderId === window.currentUser.uid) {
                statusIcon = `<span class="message-status">${message.read ? '‚úì‚úì' : '‚úì'}</span>`;
            }

            messageElement.innerHTML = `
                <div>${message.text}</div>
                <div class="message-info">${formatTime(message.timestamp)} ${statusIcon}</div>
            `; /*  */
            messagesContainer.appendChild(messageElement); /*  */
            messagesContainer.scrollTop = messagesContainer.scrollHeight; /*  */
        }

        function showTypingIndicator(isTyping) {
            const composeArea = document.getElementById('composeArea');
            let indicator = composeArea.querySelector('.typing-indicator');
            if (isTyping) {
                if (!indicator) {
                    indicator = document.createElement('div');
                    indicator.className = 'typing-indicator';
                    indicator.innerHTML = `<div class="typing-dots"><span></span><span></span><span></span></div>`;
                    composeArea.prepend(indicator);
                }
            } else {
                if (indicator) {
                    indicator.remove();
                }
            }
        }
        
        function showEmptyStateUI(state) {
            const emptyArea = document.getElementById('emptyChatArea');
            const composeArea = document.getElementById('composeArea');
            if (state === 'no_chat_selected') {
                emptyArea.classList.remove('hidden');
                document.getElementById('chatHeader').textContent = 'üåä Welcome to the Ocean';
                composeArea.style.visibility = 'hidden';
            }
        }
        
        // --- Utility & Helper Functions ---
        const getChatId = (uid1, uid2) => [uid1, uid2].sort().join('_'); /*  */
        const formatTime = (ts) => ts ? ts.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : ''; /*  */
        const showError = (msg) => {
            const errEl = document.getElementById('authError'); /*  */
            errEl.textContent = msg; /*  */
            errEl.classList.remove('hidden'); /*  */
        };
        const showNotification = (msg) => {
            const el = document.getElementById('notification'); /*  */
            el.textContent = msg; /*  */
            el.classList.add('show'); /*  */
            setTimeout(() => el.classList.remove('show'), 4000); /*  */
        };
        window.handleKeyPress = (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { /*  */
                e.preventDefault(); /*  */
                sendMessage(); /*  */
            }
        };

        async function createUserDocument(user) {
            const userRef = doc(db, 'users', user.uid); /*  */
            const userDoc = await getDoc(userRef);
            if (!userDoc.exists()) {
                await setDoc(userRef, { /*  */
                    uid: user.uid, /*  */
                    email: user.email, /*  */
                    connections: [], /*  */
                    isOnline: true, /*  */
                    createdAt: serverTimestamp(), /*  */
                });
            }
        }

        async function updateUserStatus(isOnline) {
            if (!window.currentUser) return; /*  */
            await updateDoc(doc(db, 'users', window.currentUser.uid), { isOnline, lastSeen: serverTimestamp() }); /*  */
        }
        
        async function markMessagesAsRead(chatId) {
            const q = query(collection(db, 'messages'), 
                where('chatId', '==', chatId), 
                where('receiverId', '==', window.currentUser.uid),
                where('read', '==', false)
            );
            const snapshot = await getDocs(q);
            if (snapshot.empty) return;

            const batch = writeBatch(db);
            snapshot.forEach(doc => {
                batch.update(doc.ref, { read: true });
            });
            await batch.commit();
        }
        
        // --- Event Listeners ---
        onAuthStateChanged(auth, updateUIOnAuthStateChange); /*  */
        document.addEventListener('visibilitychange', () => updateUserStatus(!document.hidden)); /*  */


    </script>
</body>
</html>
